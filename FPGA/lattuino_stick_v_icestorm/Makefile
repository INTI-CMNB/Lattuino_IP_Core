#!/usr/bin/make
##############################################################################
#
# Makefile for the lattuino_stick project, Lattuino_Stick toplevel.
# Target board: iCEstick Evaluation Kit (FPGA: iCE40HX1K-TQ144).
# Automatically generated by xil_project v0.6.3 script from lattuino_stick.xilprj.
# Based on makefiles by Salvador E. Tropea.
#
# DON'T EDIT!!!! change the project file instead
#
##############################################################################

PRJ=lattuino_stick
GENDIR=gen
OBJDIR=Work
TOP_LEVEL=Lattuino_Stick
PNR_OPS=-d 1k -P tq144
TMR_OPS=-d hx1k -c 12
DEPE=\
	../../../AVR/AVR_iCE40/core/io_reg_file.v \
	../../../AVR/AVR_iCE40/core/reg_file.v \
	../../../AVR/AVR_iCE40/core/alu.v \
	../../../AVR/AVR_iCE40/core/cpu.v \
	../../../AVR/AVR_iCE40/core/core.v \
	../../../AVR/AVR_iCE40/devices/portx.v \
	../../../AVR/AVR_iCE40/devices/wb_ctrl.v \
	../../../AVR/AVR_iCE40/devices/irq.v \
	../../../AVR/AVR_iCE40/devices/spi.v \
	../../../AVR/AVR_iCE40/memory/dm_s.v \
	../../../AVR/AVR_iCE40/micros/attX5.v \
	../../../SPI/MCP300x/mcp300x.v \
	../../../SPI/spi_master.v \
	../../../CapSense/capsense.v \
	../../../CapSense/capsense_sys.v \
	../../../miniuart/Txunit.v \
	../../../miniuart/Rxunit.v \
	../../../miniuart/utils.v \
	../../../miniuart/miniuart.v \
	../../../lattuino/devices/ad_conv.v \
	../../../lattuino/devices/tm16b.v \
	../../../lattuino/devices/tmcounter.v \
	../../../lattuino/Work/lattuino_1_bl_8.v \
	../../../lattuino/Work/lattuino_1_bl_4.v \
	../../../lattuino/Work/lattuino_1_bl_2.v \
	../../../lattuino/Work/lattuino_1_bl_2s.v \
	cpuconfig.v \
	lattuino_stick.v \
	 lattuino_stick.pcf  Makefile

all: Makefile lattuino_stick.pcf  $(GENDIR) \
	$(GENDIR)/$(PRJ).bin $(PRJ).txt

###############################################
# Regenerate the files if the project changed #
###############################################
Makefile lattuino_stick.pcf : lattuino_stick.xilprj ../lattuino_stick/lattuino_stick.in.pcf \
	../../../AVR/AVR_iCE40/FPGA/attX5_v\
	../../../SPI/FPGA/mcp300x_v\
	../../../SPI/FPGA/spi_master_v\
	../../../CapSense/FPGA/capsense_v\
	../../../miniuart/FPGA/miniuart_v\
	../../../lattuino/FPGA/devices_v
	@echo ==** Starting xil_project.pl
	/usr/bin/xil_project.pl 
	@echo ==** Ending xil_project.pl

#######################
# Working directories #
#######################
$(GENDIR):
	mkdir $(GENDIR)

######################
# IceStorm toolchain #
######################
$(GENDIR)/synth.blif: $(DEPE)
	@echo "==** Starting S√≠ntesis (Yosys)"
	cd $(GENDIR)/ ; yosys -v3 -l synth.log -p 'synth_ice40 -top $(TOP_LEVEL) -blif synth.blif; write_verilog -attr2comment synth.v' $(addprefix ../,$(filter %.v, $^))
	@echo "==** Ending Yosys"

$(GENDIR)/$(PRJ).asc: $(GENDIR)/synth.blif
	@echo "==** Starting Placer+Router  (Arachne-PNR)"
	arachne-pnr $(PNR_OPS) -o $@ -p lattuino_stick.pcf $(GENDIR)/synth.blif 2>&1 | tee $(GENDIR)/arachne.log
	@echo "==** Ending Arachne-PNR"

$(GENDIR)/icetime.log: $(GENDIR)/$(PRJ).asc
	@echo "==** Starting An√°lisis de tiempos (icetime)"
	icetime $(TMR_OPS) $< | tee $@
	@echo "==** Ending icepack"

$(GENDIR)/$(PRJ).bin: $(GENDIR)/$(PRJ).asc $(GENDIR)/icetime.log
	@echo "==** Starting Generaci√≥n del bitstream (icepack)"
	icepack $< $@
	@echo "==** Ending icepack"

XIL_RESUMEN=xil_resumen.pl $(PRJ) $(GENDIR)
ifeq (, $(shell which $(XIL_RESUMEN)))
XIL_RESUMEN=touch $(PRJ).txt
endif
###################
# Project Summary #
###################
$(PRJ).txt: $(GENDIR)/$(PRJ).bin
	@echo "==** Starting Resumen del proyecto (xil_resumen.pl)"
	$(XIL_RESUMEN)
	@echo "==** Ending xil_resumen.pl"

######################
# Board transference #
######################
transfer-rom: $(GENDIR)/$(PRJ).bin do-transfer-rom

do-transfer-rom: $(GENDIR)/$(PRJ).bin
	make_impact.pl --file=$< --mode=prom --submode=spi --board=icestick --toolchain=IceStorm

##########
# Others #
##########
clean: 
	rm -rf gen lattuino_stick.pcf  Makefile .*~

.PHONY: all transfer clean
# Asegurarse que la ROM estÈ actualizada.
.PHONY : updaterom

../../../lattuino/Work/lattuino_1_bl_2s.vhdl ../../../lattuino/Work/pm_pkg.vhdl: updaterom

updaterom:
	$(MAKE) -C ../../bootloader/ needed
